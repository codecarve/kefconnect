<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KEF Compact Player</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="widget-container homey-widget">
    <div class="player-content">
      <!-- Album Art & Track Info -->
      <div class="track-section">
        <div class="album-art" id="albumArt">
          <svg class="default-icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
          </svg>
        </div>
        <div class="track-info" role="status" aria-live="polite" aria-atomic="true">
          <div class="track-title" id="trackTitle">Loading...</div>
          <div class="track-artist" id="trackArtist">Please wait</div>
        </div>
      </div>

      <!-- Playback Controls -->
      <div class="controls-section">
        <button class="control-btn" id="prevBtn" aria-label="Previous">
          <svg viewBox="0 0 24 24">
            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
          </svg>
        </button>
        <button class="control-btn play-btn" id="playPauseBtn" aria-label="Play/Pause">
          <svg class="play-icon" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg class="pause-icon" viewBox="0 0 24 24" style="display:none">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>
        <button class="control-btn" id="nextBtn" aria-label="Next">
          <svg viewBox="0 0 24 24">
            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Offline Overlay -->
    <div class="offline-overlay" id="offlineOverlay" style="display:none" role="alert" aria-live="assertive">
      <svg class="offline-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M23.64 7c-.45-.34-4.93-4-11.64-4-1.5 0-2.89.19-4.15.48L18.18 13.8 23.64 7zm-6.6 8.22L3.27 1.44 2 2.72l2.05 2.06C1.91 5.76.59 6.82.36 7l11.63 14.49.01.01.01-.01 3.9-4.86 3.32 3.32 1.27-1.27-3.46-3.46z"/>
      </svg>
      <div class="offline-text">Device Offline</div>
    </div>
  </div>

  <script type="text/javascript">
    let widgetSettings = {};
    let currentState = null;
    let refreshInterval = null;
    let isUpdating = false;
    let currentAlbumArtUrl = null;

    // Initialize the widget when the Homey SDK is ready
    function onHomeyReady(Homey) {
      // Signal Homey that the widget is ready with proper height
      Homey.ready({ height: 160 });
      
      // Initialize the widget
      initWidget();
    }

    // Initialize widget
    async function initWidget() {
      try {
        // Get widget settings
        widgetSettings = await window.Homey.getSettings();
        
        // Get selected device ID using the new devices API
        const deviceIds = await window.Homey.getDeviceIds();
        
        if (!deviceIds || deviceIds.length === 0) {
          showError('Please select a device in widget settings');
          return;
        }
        
        // Store the first device ID (since we use singular: true)
        widgetSettings.device = deviceIds[0];
        
        // Set up refresh interval
        const interval = (widgetSettings.refresh_interval || 2) * 1000;
        
        // Initial fetch
        await updateDeviceState();
        
        // Set up polling
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(updateDeviceState, interval);
        
        // Set up event listeners
        setupEventListeners();
        
      } catch (error) {
        console.error('Failed to initialize widget:', error);
        showError('Failed to initialize');
      }
    }

    // Set up button event listeners
    function setupEventListeners() {
      const playPauseBtn = document.getElementById('playPauseBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      playPauseBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await handlePlayPause();
      });
      
      prevBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await sendCommand('previous');
      });
      
      nextBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await sendCommand('next');
      });
    }

    // Update device state
    async function updateDeviceState() {
      if (isUpdating) return;
      isUpdating = true;
      
      try {
        const response = await window.Homey.api('GET', `/device-state?deviceId=${widgetSettings.device}`);
        
        currentState = response;
        updateUI(response);
        
        // Hide offline overlay if device is available
        const offlineOverlay = document.getElementById('offlineOverlay');
        offlineOverlay.style.display = response.available ? 'none' : 'flex';
        
      } catch (error) {
        console.error('Failed to update device state:', error);
        showOffline();
      } finally {
        isUpdating = false;
      }
    }

    // Update UI with device state
    function updateUI(state) {
      // Update track info
      const trackTitle = document.getElementById('trackTitle');
      const trackArtist = document.getElementById('trackArtist');
      const albumArt = document.getElementById('albumArt');
      
      if (state.track || state.artist) {
        trackTitle.textContent = state.track || 'Unknown Track';
        trackArtist.textContent = state.artist || state.source?.toUpperCase() || 'Unknown Artist';
      } else {
        trackTitle.textContent = state.power ? 'No Track Info' : 'Device Off';
        trackArtist.textContent = state.source ? state.source.toUpperCase() : 'Select a source';
      }
      
      // Update album art only if changed
      if (widgetSettings.show_album_art !== false && state.albumArt) {
        // Only update if the URL has changed
        if (currentAlbumArtUrl !== state.albumArt) {
          currentAlbumArtUrl = state.albumArt;
          loadAlbumArtWithProxy(state.albumArt, albumArt);
        }
      } else if (currentAlbumArtUrl !== null) {
        // Only update to default icon if we previously had album art
        currentAlbumArtUrl = null;
        albumArt.innerHTML = `
          <svg class="default-icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
          </svg>
        `;
      }
      
      // Update play/pause button
      const playPauseBtn = document.getElementById('playPauseBtn');
      const playIcon = playPauseBtn.querySelector('.play-icon');
      const pauseIcon = playPauseBtn.querySelector('.pause-icon');
      
      if (state.playing) {
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
      } else {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      }
      
      // Enable/disable controls based on power state
      const controls = document.querySelectorAll('.control-btn');
      controls.forEach(btn => {
        btn.disabled = !state.power;
      });
    }

    // Handle play/pause
    async function handlePlayPause() {
      if (!currentState) return;
      
      const command = currentState.playing ? 'pause' : 'play';
      await sendCommand(command);
    }

    // Load album art using proxy endpoint
    async function loadAlbumArtWithProxy(url, albumArtElement) {
      try {
        // Add loading state
        albumArtElement.classList.add('loading');

        // Call the proxy endpoint to get the album art as data URL
        const response = await window.Homey.api('GET', `/album-art?deviceId=${widgetSettings.device}&url=${encodeURIComponent(url)}`);

        if (response && response.dataUrl) {
          const img = new Image();
          img.onload = function() {
            // Smooth transition by only replacing if loaded successfully
            albumArtElement.classList.remove('loading');
            albumArtElement.innerHTML = '';
            albumArtElement.appendChild(img);
          };
          img.onerror = function() {
            albumArtElement.classList.remove('loading');
            // Fallback to default icon
            albumArtElement.innerHTML = `
              <svg class="default-icon" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
              </svg>
            `;
            currentAlbumArtUrl = null;
          };
          img.src = response.dataUrl;
          img.alt = 'Album Art';
        } else {
          throw new Error('No data URL in response');
        }
      } catch (error) {
        // Remove loading state and fallback to default icon
        albumArtElement.classList.remove('loading');
        albumArtElement.innerHTML = `
          <svg class="default-icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
          </svg>
        `;
        currentAlbumArtUrl = null;
      }
    }

    // Send command to device
    async function sendCommand(command, value = null) {
      try {
        // Provide haptic feedback
        if (window.Homey && window.Homey.hapticFeedback) {
          window.Homey.hapticFeedback();
        }
        
        await window.Homey.api('POST', '/command', {
          deviceId: widgetSettings.device,
          command: command,
          value: value
        });
        
        // Update state after command
        setTimeout(updateDeviceState, 500);
        
      } catch (error) {
        console.error('Failed to send command:', error);
      }
    }

    // Show offline state
    function showOffline() {
      const offlineOverlay = document.getElementById('offlineOverlay');
      offlineOverlay.style.display = 'flex';
    }

    // Show error message
    function showError(message) {
      const trackTitle = document.getElementById('trackTitle');
      const trackArtist = document.getElementById('trackArtist');
      trackTitle.textContent = 'Error';
      trackArtist.textContent = message;
      
      // Disable all controls
      const controls = document.querySelectorAll('.control-btn');
      controls.forEach(btn => {
        btn.disabled = true;
      });
    }

    // Clean up on unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
  <!-- Homey SDK is injected automatically -->
</body>
</html>
