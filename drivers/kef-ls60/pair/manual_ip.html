<!DOCTYPE html>
<html>
<head>
  <style>
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .error {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 5px;
    }
    .success {
      color: #27ae60;
      font-size: 12px;
      margin-top: 5px;
    }
    .warning {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-top: 15px;
      display: none;
    }
    .warning strong {
      display: block;
      margin-bottom: 5px;
    }
    .duplicate-warning {
      background-color: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
      padding: 10px;
      border-radius: 4px;
      margin-top: 15px;
      display: none;
    }
    .duplicate-warning strong {
      display: block;
      margin-bottom: 5px;
    }
    .button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
    }
    .button:hover {
      background-color: #45a049;
    }
    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .button:not(:disabled) {
      background-color: #4CAF50;
      transition: background-color 0.3s ease;
    }
    .button:not(:disabled):hover {
      background-color: #45a049;
    }
    .button-secondary {
      background-color: #2196F3;
    }
    .button-secondary:hover {
      background-color: #0b7dda;
    }
    .detected-info {
      background-color: #f0f8ff;
      border: 1px solid #4CAF50;
      border-radius: 4px;
      padding: 10px;
      margin-top: 15px;
      display: none;
    }
    .detected-info h4 {
      margin-top: 0;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="form-group">
    <label for="ip" data-i18n="pair.manual_ip.ip">IP Address</label>
    <input type="text" id="ip" placeholder="192.168.1.100" data-i18n-placeholder="pair.manual_ip.ip_placeholder" />
    <div class="hint" data-i18n="pair.manual_ip.instruction">Enter the IP address of your KEF LS60 Wireless</div>
    <div class="error" id="ip-error" style="display: none;"></div>
  </div>

  <div class="form-group">
    <label for="port" data-i18n="pair.manual_ip.port">Port (optional)</label>
    <input type="number" id="port" placeholder="80" value="80" data-i18n-placeholder="pair.manual_ip.port_placeholder" />
  </div>

  <button id="test-button" class="button button-secondary" onclick="testConnection()" data-i18n="pair.manual_ip.test_button">Test Connection</button>
  
  <div id="detected-info" class="detected-info">
    <h4 data-i18n="pair.manual_ip.speaker_detected">Speaker Detected!</h4>
    <div id="detected-details"></div>
  </div>

  <div id="model-warning" class="warning">
    <strong data-i18n="pair.manual_ip.model_warning">⚠️ Model Mismatch Warning</strong>
    <span id="warning-text"></span>
  </div>

  <div id="duplicate-warning" class="duplicate-warning">
    <strong data-i18n="pair.manual_ip.duplicate_warning">❌ Device Already Exists</strong>
    <span id="duplicate-text"></span>
  </div>

  <div class="form-group" style="margin-top: 20px;">
    <label for="name" data-i18n="pair.manual_ip.name">Device Name</label>
    <input type="text" id="name" placeholder="Living Room Speaker" data-i18n-placeholder="pair.manual_ip.name_placeholder" />
  </div>

  <div class="form-group" style="margin-top: 20px;">
    <label style="display: flex; align-items: center; cursor: pointer;">
      <input type="checkbox" id="hide-from-speakers" style="width: auto; margin-right: 10px;" />
      <span data-i18n="pair.manual_ip.hide_from_speakers">Hide from Homey speakers section</span>
    </label>
    <div class="hint" data-i18n="pair.manual_ip.hide_from_speakers_hint">When enabled, this device won't appear in Homey's speakers section but can still be controlled via device page and flows</div>
  </div>

  <button id="connect-button" class="button" onclick="connectDevice()" title="Test connection first to enable this button" data-i18n="pair.manual_ip.add_device_button">Add Device</button>
  <div class="hint" id="connect-hint" style="text-align: center; margin-top: 5px;" data-i18n="pair.manual_ip.test_first_hint">Test the connection first to enable adding the device</div>

  <script>
    const EXPECTED_MODEL = 'KEF LS60 Wireless';
    const DRIVER_ID = 'kef-ls60';
    
    let detectedModel = null;
    let speakerInfo = null;
    let connectionTested = false;
    let lastTestedIP = null;
    let lastTestedPort = null;

    function validateIP(ip) {
      const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      return regex.test(ip);
    }

    Homey.setTitle(Homey.__('pair.manual_ip.title'));
    
    // Monitor IP and port changes to reset test status
    document.getElementById('ip').addEventListener('input', function() {
      const currentIP = this.value.trim();
      const currentPort = document.getElementById('port').value || '80';
      
      if (currentIP !== lastTestedIP || currentPort !== lastTestedPort) {
        resetTestStatus();
      }
      
      // Update test button state based on IP validity
      updateTestButtonState();
    });
    
    document.getElementById('port').addEventListener('input', function() {
      const currentIP = document.getElementById('ip').value.trim();
      const currentPort = this.value || '80';
      
      if (currentIP !== lastTestedIP || currentPort !== lastTestedPort) {
        resetTestStatus();
      }
      
      // Update test button state based on IP validity
      updateTestButtonState();
    });
    
    function updateTestButtonState() {
      const ip = document.getElementById('ip').value.trim();
      const testButton = document.getElementById('test-button');
      const isValidIP = validateIP(ip);
      
      if (!connectionTested) {
        testButton.disabled = !isValidIP;
        if (isValidIP) {
          testButton.style.backgroundColor = '#4CAF50';
          testButton.style.cursor = 'pointer';
        } else {
          testButton.style.backgroundColor = '#cccccc';
          testButton.style.cursor = 'not-allowed';
        }
      }
    }
    
    function resetTestStatus() {
      connectionTested = false;
      detectedModel = null;
      speakerInfo = null;
      
      // Hide success/error messages
      const errorEl = document.getElementById('ip-error');
      errorEl.style.display = 'none';
      
      // Hide detected info
      const infoDiv = document.getElementById('detected-info');
      infoDiv.style.display = 'none';
      
      // Hide warnings
      const warningDiv = document.getElementById('model-warning');
      warningDiv.style.display = 'none';
      const duplicateDiv = document.getElementById('duplicate-warning');
      duplicateDiv.style.display = 'none';
      
      // Disable Add Device button and reset styling
      const connectButton = document.getElementById('connect-button');
      connectButton.disabled = true;
      connectButton.style.backgroundColor = '';
      connectButton.title = 'Test connection first to enable this button';
      const connectHint = document.getElementById('connect-hint');
      connectHint.style.display = 'block';
      
      // Update test button appearance based on IP validity
      updateTestButtonState();
    }
    
    // Initially disable buttons and set initial state
    window.addEventListener('load', function() {
      const connectButton = document.getElementById('connect-button');
      connectButton.disabled = true;
      connectButton.style.backgroundColor = '#cccccc';
      
      // Set initial test button state
      updateTestButtonState();
    });
    
    async function testConnection() {
      const ip = document.getElementById('ip').value.trim();
      const port = document.getElementById('port').value || '80';
      const errorEl = document.getElementById('ip-error');
      const button = document.getElementById('test-button');
      const infoDiv = document.getElementById('detected-info');
      const detailsDiv = document.getElementById('detected-details');
      const warningDiv = document.getElementById('model-warning');
      const warningText = document.getElementById('warning-text');

      if (!ip) {
        errorEl.textContent = 'Please enter an IP address';
        errorEl.style.display = 'block';
        return;
      }

      if (!validateIP(ip)) {
        errorEl.textContent = 'Invalid IP address format';
        errorEl.style.display = 'block';
        return;
      }

      errorEl.style.display = 'none';
      button.disabled = true;
      button.textContent = 'Testing...';
      infoDiv.style.display = 'none';
      warningDiv.style.display = 'none';

      // First check for duplicate device
      try {
        const duplicateCheck = await Homey.emit('check_duplicate', { ip });
        if (duplicateCheck.isDuplicate) {
          const duplicateDiv = document.getElementById('duplicate-warning');
          const duplicateText = document.getElementById('duplicate-text');
          duplicateText.textContent = `A device with IP address ${ip} already exists in Homey as "${duplicateCheck.deviceName}". You cannot add the same device twice.`;
          duplicateDiv.style.display = 'block';
          
          errorEl.textContent = 'Device already exists';
          errorEl.className = 'error';
          errorEl.style.display = 'block';
          
          // Don't continue with connection test
          button.disabled = false;
          button.textContent = 'Test Connection';
          return;
        }
      } catch (error) {
        // Continue with connection test if duplicate check fails
        console.error('Duplicate check failed:', error);
      }

      // Hide duplicate warning if not duplicate
      const duplicateDiv = document.getElementById('duplicate-warning');
      duplicateDiv.style.display = 'none';

      try {
        const result = await Homey.emit('test_connection', { ip, port: parseInt(port) });
        
        if (result.success) {
          // Mark connection as tested successfully
          connectionTested = true;
          lastTestedIP = ip;
          lastTestedPort = port;
          detectedModel = result.model;
          speakerInfo = result.speakerInfo;
          
          // Show detected info
          detailsDiv.innerHTML = `
            <strong>Name:</strong> ${speakerInfo.name || 'KEF Speaker'}<br>
            <strong>Model:</strong> ${speakerInfo.model || 'Unknown'}<br>
            <strong>Serial Number:</strong> ${speakerInfo.serialNumber || 'Unknown'}
          `;
          infoDiv.style.display = 'block';
          
          // Check for model mismatch
          const detectedModelName = speakerInfo.model || 'Unknown';
          if (!detectedModelName.toLowerCase().includes('ls60') || !detectedModelName.toLowerCase().includes('ii')) {
            // Model mismatch - show warning
            warningText.textContent = `You selected to add a ${EXPECTED_MODEL}, but detected: ${detectedModelName}. You can continue, but the device may not work correctly with this driver.`;
            warningDiv.style.display = 'block';
          }
          
          // Auto-fill name if available
          const nameInput = document.getElementById('name');
          if (speakerInfo.name && !nameInput.value) {
            nameInput.value = speakerInfo.name;
          }
          
          errorEl.textContent = 'Connection successful!';
          errorEl.className = 'success';
          errorEl.style.display = 'block';
          
          // Enable the Add Device button and update styling
          const connectButton = document.getElementById('connect-button');
          connectButton.disabled = false;
          connectButton.style.backgroundColor = '#4CAF50';
          connectButton.title = 'Click to add the device to Homey';
          
          // Hide the hint since button is now enabled
          const connectHint = document.getElementById('connect-hint');
          connectHint.style.display = 'none';
          
          // Update test button to show success
          button.style.backgroundColor = '#4CAF50';
          button.textContent = '✓ Connection Tested';
        } else {
          // Connection test failed
          connectionTested = false;
          errorEl.textContent = 'Connection test failed';
          errorEl.className = 'error';
          errorEl.style.display = 'block';
          
          // Keep Add Device button disabled
          const connectButton = document.getElementById('connect-button');
          connectButton.disabled = true;
        }
      } catch (error) {
        connectionTested = false;
        errorEl.textContent = error.message || 'Connection failed';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        
        // Keep Add Device button disabled
        const connectButton = document.getElementById('connect-button');
        connectButton.disabled = true;
      } finally {
        button.disabled = false;
        if (!connectionTested) {
          button.textContent = 'Test Connection';
        }
      }
    }
    
    async function connectDevice() {
      const ip = document.getElementById('ip').value.trim();
      const port = document.getElementById('port').value || '80';
      const name = document.getElementById('name').value.trim() || speakerInfo?.name || EXPECTED_MODEL;
      const errorEl = document.getElementById('ip-error');

      // Check if connection has been tested
      if (!connectionTested || ip !== lastTestedIP || port !== lastTestedPort) {
        errorEl.textContent = 'Please test the connection first';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        return;
      }

      if (!ip) {
        errorEl.textContent = 'Please enter an IP address';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        return;
      }

      if (!validateIP(ip)) {
        errorEl.textContent = 'Invalid IP address format';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        return;
      }

      errorEl.style.display = 'none';
      
      // Disable button while connecting
      const button = document.getElementById('connect-button');
      button.disabled = true;
      button.textContent = 'Adding device...';

      try {
        // Get visibility preference
        const hideFromSpeakers = document.getElementById('hide-from-speakers').checked;
        
        // Create device with the driver's model ID and visibility preference
        const device = await Homey.emit('create_device', {
          ip: ip,
          port: parseInt(port),
          name: name,
          model: DRIVER_ID,
          hideFromSpeakers: hideFromSpeakers
        });

        // Add device and complete pairing
        await Homey.createDevice(device);
        await Homey.done();
      } catch (error) {
        errorEl.textContent = error.message || 'Failed to add device';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        button.disabled = false;
        button.textContent = 'Add Device';
      }
    }
  </script>
</body>
</html>