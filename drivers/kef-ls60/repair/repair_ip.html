<!DOCTYPE html>
<html>
<head>
  <style>
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .error {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 5px;
    }
    .success {
      color: #27ae60;
      font-size: 12px;
      margin-top: 5px;
    }
    .info-box {
      background-color: #e3f2fd;
      border: 1px solid #2196F3;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 15px;
    }
    .info-box strong {
      color: #1976D2;
    }
    .button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
    }
    .button:hover {
      background-color: #45a049;
    }
    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .button-secondary {
      background-color: #2196F3;
    }
    .button-secondary:hover {
      background-color: #0b7dda;
    }
    .detected-info {
      background-color: #f0f8ff;
      border: 1px solid #4CAF50;
      border-radius: 4px;
      padding: 10px;
      margin-top: 15px;
      display: none;
    }
    .detected-info h4 {
      margin-top: 0;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="info-box">
    <strong>Connection Lost</strong><br>
    The connection to your KEF LS60 Wireless has been lost. This usually happens when the speaker's IP address has changed.
  </div>

  <div class="form-group">
    <label for="ip" data-i18n="repair.ip">IP Address</label>
    <input type="text" id="ip" placeholder="192.168.1.100" data-i18n-placeholder="repair.ip_placeholder" />
    <div class="hint" data-i18n="repair.instruction">Enter the new IP address of your KEF LS60 Wireless</div>
    <div class="error" id="ip-error" style="display: none;"></div>
  </div>

  <div class="form-group">
    <label for="port" data-i18n="repair.port">Port (optional)</label>
    <input type="number" id="port" placeholder="80" value="80" data-i18n-placeholder="repair.port_placeholder" />
  </div>

  <button id="test-button" class="button button-secondary" onclick="testConnection()">Test Connection</button>
  
  <div id="detected-info" class="detected-info">
    <h4>Speaker Found!</h4>
    <div id="detected-details"></div>
  </div>

  <button id="repair-button" class="button" onclick="repairDevice()" disabled>Update Connection</button>
  <div class="hint" id="repair-hint" style="text-align: center; margin-top: 5px;">Test the connection first to enable updating</div>

  <script>
    const EXPECTED_MODEL = 'KEF LS60 Wireless';
    
    let speakerInfo = null;
    let connectionTested = false;
    let currentSettings = {};

    function validateIP(ip) {
      const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      return regex.test(ip);
    }

    Homey.setTitle(Homey.__('repair.title'));
    
    // Listen for current settings from driver
    Homey.on('current_settings', (settings) => {
      currentSettings = settings;
      if (settings.ip) {
        document.getElementById('ip').value = settings.ip;
      }
      if (settings.port) {
        document.getElementById('port').value = settings.port;
      }
      // Update button state after loading settings
      updateTestButtonState();
    });
    
    // Monitor IP changes to update test button state
    document.getElementById('ip').addEventListener('input', function() {
      updateTestButtonState();
      resetTestStatus();
    });
    
    document.getElementById('port').addEventListener('input', function() {
      resetTestStatus();
    });
    
    function updateTestButtonState() {
      const ip = document.getElementById('ip').value.trim();
      const testButton = document.getElementById('test-button');
      const isValidIP = validateIP(ip);
      
      if (!connectionTested) {
        testButton.disabled = !isValidIP;
        if (isValidIP) {
          testButton.style.backgroundColor = '#4CAF50';
          testButton.style.cursor = 'pointer';
        } else {
          testButton.style.backgroundColor = '#cccccc';
          testButton.style.cursor = 'not-allowed';
        }
      }
    }
    
    function resetTestStatus() {
      connectionTested = false;
      speakerInfo = null;
      
      // Hide success/error messages
      const errorEl = document.getElementById('ip-error');
      errorEl.style.display = 'none';
      
      // Hide detected info
      const infoDiv = document.getElementById('detected-info');
      infoDiv.style.display = 'none';
      
      // Disable repair button
      const repairButton = document.getElementById('repair-button');
      repairButton.disabled = true;
      repairButton.style.backgroundColor = '#cccccc';
      const repairHint = document.getElementById('repair-hint');
      repairHint.style.display = 'block';
    }
    
    // Set initial state on load
    window.addEventListener('load', function() {
      updateTestButtonState();
    });
    
    async function testConnection() {
      const ip = document.getElementById('ip').value.trim();
      const port = document.getElementById('port').value || '80';
      const errorEl = document.getElementById('ip-error');
      const button = document.getElementById('test-button');
      const infoDiv = document.getElementById('detected-info');
      const detailsDiv = document.getElementById('detected-details');

      if (!ip) {
        errorEl.textContent = 'Please enter an IP address';
        errorEl.style.display = 'block';
        return;
      }

      if (!validateIP(ip)) {
        errorEl.textContent = 'Invalid IP address format';
        errorEl.style.display = 'block';
        return;
      }

      errorEl.style.display = 'none';
      button.disabled = true;
      button.textContent = 'Testing...';
      infoDiv.style.display = 'none';

      try {
        const result = await Homey.emit('test_connection', { ip, port: parseInt(port) });
        
        if (result.success) {
          connectionTested = true;
          speakerInfo = result.speakerInfo;
          
          // Show detected info
          detailsDiv.innerHTML = `
            <strong>Model:</strong> ${speakerInfo.model || 'Unknown'}<br>
            <strong>Name:</strong> ${speakerInfo.name || 'KEF Speaker'}<br>
            ${speakerInfo.firmware ? `<strong>Firmware:</strong> ${speakerInfo.firmware}<br>` : ''}
          `;
          infoDiv.style.display = 'block';
          
          // Check if it's the expected model
          const detectedModelName = speakerInfo.model || 'Unknown';
          if (!detectedModelName.toLowerCase().includes('ls60') || !detectedModelName.toLowerCase().includes('ii')) {
            detailsDiv.innerHTML += `<br><span style="color: #ff9800;">⚠️ Warning: Expected ${EXPECTED_MODEL} but found ${detectedModelName}</span>`;
          }
          
          errorEl.textContent = 'Connection successful!';
          errorEl.className = 'success';
          errorEl.style.display = 'block';
          
          // Enable repair button
          const repairButton = document.getElementById('repair-button');
          repairButton.disabled = false;
          repairButton.style.backgroundColor = '#4CAF50';
          
          // Hide hint
          const repairHint = document.getElementById('repair-hint');
          repairHint.style.display = 'none';
          
          // Update test button
          button.style.backgroundColor = '#4CAF50';
          button.textContent = '✓ Connection Tested';
        } else {
          connectionTested = false;
          errorEl.textContent = 'Connection test failed';
          errorEl.className = 'error';
          errorEl.style.display = 'block';
          
          document.getElementById('repair-button').disabled = true;
        }
      } catch (error) {
        connectionTested = false;
        errorEl.textContent = error.message || 'Connection failed';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        
        document.getElementById('repair-button').disabled = true;
      } finally {
        button.disabled = false;
        if (!connectionTested) {
          button.textContent = 'Test Connection';
        }
      }
    }
    
    async function repairDevice() {
      const ip = document.getElementById('ip').value.trim();
      const port = document.getElementById('port').value || '80';
      const errorEl = document.getElementById('ip-error');
      const button = document.getElementById('repair-button');

      if (!connectionTested) {
        errorEl.textContent = 'Please test the connection first';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        return;
      }

      if (!ip) {
        errorEl.textContent = 'Please enter an IP address';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        return;
      }

      if (!validateIP(ip)) {
        errorEl.textContent = 'Invalid IP address format';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        return;
      }

      errorEl.style.display = 'none';
      button.disabled = true;
      button.textContent = 'Updating...';

      try {
        // Update device settings
        await Homey.emit('update_device', {
          ip: ip,
          port: parseInt(port)
        });

        // Success - close repair
        await Homey.done();
      } catch (error) {
        errorEl.textContent = error.message || 'Failed to update device';
        errorEl.className = 'error';
        errorEl.style.display = 'block';
        button.disabled = false;
        button.textContent = 'Update Connection';
      }
    }
  </script>
</body>
</html>